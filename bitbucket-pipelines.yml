image: node:18

options:
  max-time: 30

definitions:
  caches:
    node: node_modules

  steps:
    - step: &lint
        name: Lint and Type Check
        caches:
          - node
        script:
          - npm ci
          - npm run lint
          - npm run type-check
          - npm run format:check

    - step: &mirror_github
        name: Mirror to GitHub
        script:
          - echo "[MIRROR] Starting sync to GitHub..."
          - apt-get update && apt-get install -y git
          - git config --global user.email "ci-bot@bitbucket.org"
          - git config --global user.name "Bitbucket CI Bot"
          - git remote add github "https://x-access-token:${SEEMA_GITHUB_TOKEN}@${GITHUB_REPO_URL}"
          - git push --mirror github
          - echo "[MIRROR] Sync completed!"

pipelines:
  branches:
    main:
      - step: *lint
      - step: *mirror_github
      - step:
          name: Build & Deploy (Kudu ZIP Deploy)
          deployment: production
          caches:
            - node
          script:
            - apt-get update && apt-get install -y zip unzip
            - rm -rf .next
            - rm -rf out-deploy.zip
            - rm -rf out
            - npm ci
            - npm run build
            - rm -rf .next/cache
            - ls -lh next.config.ts
            - rm -f out-deploy.zip
            - zip -r out-deploy.zip .next public package.json package-lock.json next.config.ts 2>/dev/null -x ".git/*" "node_modules/*" "*.env*" ".next/cache/*"
            - ls -lh out-deploy.zip
            - unzip -l out-deploy.zip | head -20
            - echo "Checking for cache in zip..."
            - unzip -l out-deploy.zip | grep "\.next/cache/" || echo "OK - No cache found in zip"
            - curl -v -X POST -u "$AZURE_USER:$AZURE_PASS" -T out-deploy.zip "$AZURE_DEPLOY_URL"
