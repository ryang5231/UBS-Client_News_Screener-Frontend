image: node:20

pipelines:
  branches:
    main: 
      - step:
          name: Build & Deploy to Production
          caches:
            - node
          script:
            # 0) Clean NPM cache
            - npm cache clean --force

            # 1) Install dependencies
            - npm ci

            # 2) Build the app
            - npm run build

            # 3) Keep only production dependencies
            - npm prune --omit=dev

            # 4) Verify build output
            - ls -la .next

            # 5) Install zip
            - apt-get update && apt-get install -y zip

            # 6) Package runtime bits
            - zip -r release.zip .next public package.json package-lock.json next.config.*

            # 7) Debug: ensure variables exist
            - echo "Deploying main branch to Production Web App"
            - echo "AZURE_SCM_URL=$AZURE_SCM_URL"
            - echo "DEPLOY_USER=$DEPLOY_USER"
            - echo "DEPLOY_PWD length=${#DEPLOY_PWD}"
            - |
              if [ -z "$AZURE_SCM_URL" ] || [ -z "$DEPLOY_USER" ] || [ -z "$DEPLOY_PWD" ]; then
                echo "❌ Missing one or more deployment variables"
                exit 1
              fi

            # 8) Confirm release.zip exists
            - ls -lh release.zip || { echo "❌ release.zip not found"; exit 1; }

            # 9) Deploy via Kudu Zip Deploy
            - curl -X POST -u "$DEPLOY_USER:$DEPLOY_PWD" \
              "https://$AZURE_SCM_URL/api/zipdeploy" \
              --data-binary "@release.zip"


